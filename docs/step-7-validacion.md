# Step 7 — Human-In-The-Loop Validation (Analysis Summary)

## Coverage

- Backend coverage: all `GesvenApi/**/*.cs` files were enumerated and reviewed (37/37).
- Frontend coverage: routing/session wiring and integration points were reviewed at a “map the product” level (mock vs real API calls), sufficient for documentation but not an exhaustive per-file UI deep read.

## What Was Verified In Code

### API conventions

- Standard response wrapper: `RespuestaApi<T>` with `Exito`, `Mensaje`, `Datos`, `Errores`. See [GesvenApi/Models/Dtos/Responses/RespuestaApi.cs](../GesvenApi/Models/Dtos/Responses/RespuestaApi.cs).
- DTO mapping: controllers centralize entity→DTO mapping via AutoMapper profiles (see `GesvenApi/Mapping/`), frequently using query projections to keep list endpoints consistent.
- Infrastructure: EF Core SQL Server configured with retry, CORS policy for frontend, OpenAPI in dev. See [GesvenApi/Program.cs](../GesvenApi/Program.cs).
- Database schema: See [GesvenApi/Scripts/DBGESVENFULL.sql](../GesvenApi/Scripts/DBGESVENFULL.sql).

### Status (Estatus) normalization

- Status IDs are resolved via `IEstatusLookupService` against `Aud.EstatusGeneral` using `(modulo, nombre)` (normalized), with fallback to `(null, nombre)` and caching. See [GesvenApi/Services/Implementations/EstatusLookupService.cs](../GesvenApi/Services/Implementations/EstatusLookupService.cs).
- Note: `Transferencia.Estatus` is a string (e.g., `EnTransito`, `Recibida`, `Cancelada`), unlike compras/ventas/productos/usuarios that use `EstatusId` pointing at `EstatusGeneral`. See [GesvenApi/Models/Inventario/Transferencia.cs](../GesvenApi/Models/Inventario/Transferencia.cs).

### Inventory semantics (ledger-based)

- Inventory is computed from the latest `Movimiento.SaldoFinal` per `(InstalacionId, ProductoId)`.
- Movements are generated by:
  - receiving purchase orders (entries),
  - registering sales (exits),
  - transfers (origin exit + destination entry on reception),
  - physical adjustments (entry/exit).
- Core entities: `Producto`, `Movimiento`, `AjusteInventario`, `Transferencia`, `TransferenciaDetalle` in [GesvenApi/Models/Inventario/](../GesvenApi/Models/Inventario/).

**Contract note:** `MovimientoId` is backed by SQL Server `bigint` (modeled as `long` in the backend). Clients should not assume 32-bit integer ranges for movement identifiers.

### Core business workflows (backend)

- Compras (Ordenes de compra): create, list/filter, approve/reject (motivo required for reject), receive with per-line validation and movement creation for inventariable items.
  - Key models: `OrdenCompra`, `OrdenCompraDetalle`, `Proveedor`.
  - Controllers: [GesvenApi/Controllers/ComprasController.cs](../GesvenApi/Controllers/ComprasController.cs), [GesvenApi/Controllers/ProveedoresController.cs](../GesvenApi/Controllers/ProveedoresController.cs).

- Ventas: create sale with stock validation for inventariable items, generate `Folio`, create salida movements, cancel updates status.
  - Key models: `Venta`, `VentaDetalle`, `Cliente`.
  - Controllers: [GesvenApi/Controllers/VentasController.cs](../GesvenApi/Controllers/VentasController.cs), [GesvenApi/Controllers/ClientesController.cs](../GesvenApi/Controllers/ClientesController.cs).

- Transferencias: create validates stock at origin, generates folio and salida movements; receiving creates entrada movements and updates status; cancel updates status.
  - Models: [GesvenApi/Models/Inventario/Transferencia.cs](../GesvenApi/Models/Inventario/Transferencia.cs).
  - Controller: [GesvenApi/Controllers/TransferenciasController.cs](../GesvenApi/Controllers/TransferenciasController.cs).

- Ajustes: create validates non-negative resulting balance; writes `AjusteInventario` and related `Movimiento`.
  - Controller: [GesvenApi/Controllers/AjustesController.cs](../GesvenApi/Controllers/AjustesController.cs).

- Movimientos: list/filter by installation/product/date range.
  - Controller: [GesvenApi/Controladores/MovimientosController.cs](../GesvenApi/Controladores/MovimientosController.cs).

- Inventario: list inventory and product catalog views; “costo sugerido” uses factor `FactorCostoSugerido`.
  - Controller: [GesvenApi/Controladores/InventarioController.cs](../GesvenApi/Controladores/InventarioController.cs).
  - Constants: [GesvenApi/ConstantesGesven.cs](../GesvenApi/ConstantesGesven.cs).

- Instalaciones context: reads `X-Gesven-UsuarioId` header to list installations based on `AccesoInstalacion`.
  - Controller: [GesvenApi/Controladores/InstalacionesController.cs](../GesvenApi/Controladores/InstalacionesController.cs).
  - Model: [GesvenApi/Modelos/Seguridad/AccesoInstalacion.cs](../GesvenApi/Modelos/Seguridad/AccesoInstalacion.cs).

- Dashboard: computes KPIs (pending purchases, sales totals for current month, low stock count) using estatus lookup and ledger-derived stock.
  - Controller: [GesvenApi/Controladores/DashboardController.cs](../GesvenApi/Controladores/DashboardController.cs).

## Known Gaps / Risks

- Secrets management risk: database connection details exist in config files; ensure secrets are not committed and use environment variables / user-secrets for local dev.
- Transfer status is string-based while other modules use `EstatusGeneral` IDs; consider normalizing if reporting and cross-module filtering become important.
- Audit stamping in `SaveChanges` uses a constant `UsuarioSistemaId` unless expanded to flow the acting user through the API.

## Validation Question (Step 7)

Is this analysis correct and comprehensive for the current repo? Are there any missing modules, workflows, or external integrations (jobs, stored procedures, finance/accounting flows) that live outside this codebase?
